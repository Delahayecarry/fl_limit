name: Release

# 触发条件：当创建新的 tag 时触发
on:
  push:
    tags:
      - 'v*'  # 匹配以 v 开头的 tag，如 v1.0.0, v2.1.3

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # 允许创建 release 和上传文件

    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'  # 与 go.mod 保持一致

      # 获取版本号（从 tag 中提取）
      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # 构建 Linux amd64 二进制文件
      - name: Build binary
        run: |
          # 创建输出目录
          mkdir -p dist

          # 构建 Linux amd64
          echo "Building Linux amd64..."
          GOOS=linux GOARCH=amd64 go build -o dist/fl_limit-linux-amd64 -ldflags="-s -w" .

          # 添加执行权限
          chmod +x dist/*

          # 显示构建的文件
          ls -lah dist/

      # 压缩二进制文件
      - name: Compress binaries
        run: |
          cd dist
          for file in fl_limit-*; do
            tar czf "${file}.tar.gz" "${file}"
            echo "Compressed ${file} to ${file}.tar.gz"
          done
          cd ..

      # 生成 SHA256 校验和
      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.tar.gz > SHA256SUMS
          cat SHA256SUMS
          cd ..

      # 创建 Release
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## 更新内容

            ### 下载说明

            下载 Linux x86_64 版本：
            - `fl_limit-linux-amd64.tar.gz` - Linux x86_64

            ### 使用方法

            1. 下载文件
            2. 解压：`tar -xzf fl_limit-linux-amd64.tar.gz`
            3. 添加执行权限：`chmod +x fl_limit-linux-amd64`
            4. 创建配置文件 `config.yaml`
            5. 运行：`./fl_limit-linux-amd64 -config config.yaml`

            ### 校验文件完整性

            使用 SHA256SUMS 文件验证下载的文件：
            ```bash
            sha256sum -c SHA256SUMS
            ```
          draft: false
          prerelease: false

      # 上传 Release 资产
      - name: Upload Release Assets
        run: |
          # 上传所有压缩文件和校验和文件
          for file in dist/*.tar.gz dist/SHA256SUMS; do
            echo "Uploading $file..."
            gh release upload "${{ steps.get_version.outputs.VERSION }}" "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}